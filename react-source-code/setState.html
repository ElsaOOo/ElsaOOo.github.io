<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <link rel="icon" href="/favicon.ico"><title>setState 是同步还是异步的？ | ElsaOOo Blog</title><meta name="description" content="react 源码解析，react setState"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.6">
    <link rel="preload" href="/assets/js/runtime~app.65ba7df6.js" as="script"><link rel="preload" href="/assets/css/styles.e6b0f612.css" as="style"><link rel="preload" href="/assets/js/693.34b4eedc.js" as="script"><link rel="preload" href="/assets/js/app.5a9508f1.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.e6b0f612.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class=""></path></svg></div><span><a href="/" class=""><!----><span class="site-name">ElsaOOo Blog</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/about-me/" class="nav-link" aria-label="关于我"><!--[--><!--]--> 关于我 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><!----></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/about-me/" class="nav-link" aria-label="关于我"><!--[--><!--]--> 关于我 <!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><section class="sidebar-group"><p class="sidebar-heading">JavaScript</p><ul class=""><li><!--[--><a href="/javascript/acron-demo.html" class="nav-link sidebar-link" aria-label="如何自己实现一个简单的tree shaking"><!--[--><!--]--> 如何自己实现一个简单的tree shaking <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/javascript/data-types.html" class="nav-link sidebar-link" aria-label="JavaScript 的数据类型"><!--[--><!--]--> JavaScript 的数据类型 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/javascript/flatten-array.html" class="nav-link sidebar-link" aria-label="JS 数组扁平化的几种方式"><!--[--><!--]--> JS 数组扁平化的几种方式 <!--[--><!--]--></a><!----><!--]--></li></ul></section><!--]--><!--[--><section class="sidebar-group"><p class="sidebar-heading active">react源码阅读</p><ul class=""><li><!--[--><a href="/react-source-code/createElement.html" class="nav-link sidebar-link" aria-label="React.createElement"><!--[--><!--]--> React.createElement <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/react-source-code/memo.html" class="nav-link sidebar-link" aria-label="React.memo"><!--[--><!--]--> React.memo <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/react-source-code/react-router.html" class="nav-link sidebar-link" aria-label="react-router 源码阅读"><!--[--><!--]--> react-router 源码阅读 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/react-source-code/ref-lazy.html" class="nav-link sidebar-link" aria-label="React.createRef"><!--[--><!--]--> React.createRef <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/react-source-code/setState.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-link active" aria-label="setState 是同步还是异步的？"><!--[--><!--]--> setState 是同步还是异步的？ <!--[--><!--]--></a><ul class="sidebar-sub-headers"><li><!--[--><a aria-current="page" href="/react-source-code/setState.html#那么批处理是如何实现的呢" class="router-link-active router-link-exact-active nav-link sidebar-link" aria-label="那么批处理是如何实现的呢？"><!--[--><!--]--> 那么批处理是如何实现的呢？ <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul></section><!--]--><!--[--><section class="sidebar-group"><p class="sidebar-heading">数据结构与算法</p><ul class=""><li><!--[--><a href="/algorithm/bubble-sort.html" class="nav-link sidebar-link" aria-label="冒泡排序"><!--[--><!--]--> 冒泡排序 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/algorithm/insert-sort.html" class="nav-link sidebar-link" aria-label="插入排序"><!--[--><!--]--> 插入排序 <!--[--><!--]--></a><!----><!--]--></li></ul></section><!--]--><!--[--><section class="sidebar-group"><p class="sidebar-heading">electron 实战</p><ul class=""><li><!--[--><a href="/electron/01.html" class="nav-link sidebar-link" aria-label="Electron 安装"><!--[--><!--]--> Electron 安装 <!--[--><!--]--></a><!----><!--]--></li></ul></section><!--]--><!--[--><section class="sidebar-group"><p class="sidebar-heading">js正则</p><ul class=""><li><!--[--><a href="/regex/regex-you-should-know.html" class="nav-link sidebar-link" aria-label="你应该知道的一些正则知识"><!--[--><!--]--> 你应该知道的一些正则知识 <!--[--><!--]--></a><!----><!--]--></li></ul></section><!--]--><!--[--><section class="sidebar-group"><p class="sidebar-heading">Java学习</p><ul class=""><li><!--[--><a href="/java/basic-types.html" class="nav-link sidebar-link" aria-label="Java--基础类型"><!--[--><!--]--> Java--基础类型 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/java/variable-constant.html" class="nav-link sidebar-link" aria-label="变量与常量"><!--[--><!--]--> 变量与常量 <!--[--><!--]--></a><!----><!--]--></li></ul></section><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="setstate-是同步还是异步的"><a class="header-anchor" href="#setstate-是同步还是异步的">#</a> setState 是同步还是异步的？</h1><blockquote><p><strong>本文用的react版本是 17.0.1</strong></p></blockquote><p>一般setState是对class components来说的。</p><p>看一下基础代码：</p><div class="language-jsx ext-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">&#39;react&#39;</span>

<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    num<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    text<span class="token operator">:</span> <span class="token string">&#39;&#39;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;before&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      num<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>num <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;after&#39;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;render&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> num <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>num<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">加1</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>这段代码在控制台中的输出结果是：</p><div class="language-jsx ext-jsx line-numbers-mode"><pre class="language-jsx"><code>before <span class="token number">0</span>
after <span class="token number">0</span>
render
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里setState是异步的。造成这个的原因是react中有性能优化机制，叫做<code>batchedUpdates</code>，从字面意思来看就是批量更新。 比如我们刚才点击按钮触发的click事件中，有多次setState操作，react会将多次setState操作合并为一次更新，这样render就只会执行一次，从而减少不必要的渲染。</p><h3 id="那么批处理是如何实现的呢"><a class="header-anchor" href="#那么批处理是如何实现的呢">#</a> 那么批处理是如何实现的呢？</h3><p>react源码中</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// the renderer. Such as when we&#39;re dispatching events or if third party</span>
<span class="token comment">// libraries need to call batchedUpdates. Eventually, this API will go away when</span>
<span class="token comment">// everything is batched by default. We&#39;ll then have a similar API to opt-out of</span>
<span class="token comment">// scheduled work and instead do synchronous work.</span>
<span class="token comment">// Defaults</span>

<span class="token keyword">var</span> <span class="token function-variable function">batchedUpdatesImpl</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> bookkeeping</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>bookkeeping<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// </span>
<span class="token keyword">var</span> isInsideEventHandler <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">batchedUpdates</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> bookkeeping</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isInsideEventHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// If we are currently inside another batch, we need to wait until it</span>
    <span class="token comment">// fully completes before restoring state.</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>bookkeeping<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  isInsideEventHandler <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">batchedUpdatesImpl</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> bookkeeping<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    isInsideEventHandler <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">finishEventHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">2021/4/3 上午9:10:33</span></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/react-source-code/ref-lazy.html" class="nav-link" aria-label="React.createRef"><!--[--><!--]--> React.createRef <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.65ba7df6.js" defer></script><script src="/assets/js/693.34b4eedc.js" defer></script><script src="/assets/js/app.5a9508f1.js" defer></script>
  </body>
</html>
