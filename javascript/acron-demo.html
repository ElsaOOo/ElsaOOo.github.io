<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <link rel="icon" href="/favicon.ico"><script src="/prism.js"></script><title>如何自己实现一个简单的tree shaking | ElsaOOo Blog</title><meta name="description" content="AST 编译原理 JS编译器"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="preload" href="/assets/js/runtime~app.f8bce1fc.js" as="script"><link rel="preload" href="/assets/css/styles.5a529915.css" as="style"><link rel="preload" href="/assets/js/621.f75be8b1.js" as="script"><link rel="preload" href="/assets/js/app.cd85d261.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.5a529915.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="global-layout"><header class="page-header"><div class="datetime"><span>login: </span><a href="/about-me" class="about-me">关于我</a></div><div class="input"><div class="block-1"><img src="/assets/img/mac.f535b1d3.svg" alt="mac.png" class="block-1-img"></div><div class="block-2"><img src="/assets/img/home.056909d2.svg" alt="home.png" class="block-2-img"><span class="path">~/javascript/acron-demo.html</span></div><span class="angle"></span></div></header><div class="content-wrap theme-content"><!--[--><h1 id="如何自己实现一个简单的tree-shaking" tabindex="-1"><a class="header-anchor" href="#如何自己实现一个简单的tree-shaking" aria-hidden="true">#</a> 如何自己实现一个简单的tree shaking</h1><p>tree shaking 简单理解就是在代码打包时将项目代码中没有用到的代码剔除掉，比如在一个文件中申明了一个工具函数，但是并没有调用它，把这样的代码剔除掉，以减少代码打包体积。</p><h3 id="acron" tabindex="-1"><a class="header-anchor" href="#acron" aria-hidden="true">#</a> acron</h3><p><a href="https://github.com/acornjs/acorn" target="_blank" rel="noopener noreferrer">acron<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!----></span></a> A tiny, fast JavaScript parser, written completely in JavaScript。 是用js写的js语言的解析器。用它可以将js代码进行词法分析，语法分析，进而得到ast，处理ast得到我们想要的结果。 这里就用acron的能力，进行js的语法分析。</p><p>整体思路是，读取一个文件中的代码，调用acron进行语法分析，剔除没有调用过的函数，结果再输出到一个新的文件中。</p><div class="language-javascript ext-js"><pre class="language-javascript"><code>// test.js  源代码
const add = (a, b) =&gt; a + b;

const subtract = (a, b) =&gt; a - b;   // 这个函数没有被调用，在shaking后，会剔除这个函数

const num1 = 9;
const num2 = 100;

const result = add(num1, num2);
</code></pre></div><p>整个项目的文件结构是：</p><div class="language-bash ext-sh"><pre class="language-bash"><code>project
   src
    |--- index.js   // 入口文件
    |--- test.js    // 源代码
    |--- visitor.js // 处理ast的代码
</code></pre></div><p>文件内容</p><div class="language-javascript ext-js"><pre class="language-javascript"><code>// index.js   // 入口文件
const fs = require(&#39;fs&#39;);
const acron = require(&#39;acorn&#39;);
const Visitor = require(&#39;./visitor&#39;);
const visitor = new Visitor();
// 获取命令行参数
const args = process.argv[2];
const buffer = fs.readFileSync(args).toString();
const body = acron.parse(buffer).body;

const decls = new Map(); // 记录所有申明过的变量
const calledDecls = []; // 记录调用过的函数
let code = []; // 存放源代码

body.forEach(node =&gt; {
    if (node.type === &#39;VariableDeclaration&#39;) {
        const kind = node.kind;
        for (const decl of node.declarations) {
            // todo
            decls.set(visitor.visitNode(decl.id), visitor.visitVariableDeclarator(decl, kind))
            if (decl.init.type === &#39;CallExpression&#39;) {
                calledDecls.push(visitor.visitIdentifier(decl.init.callee))
                const args = decl.init.arguments;
                for (const arg of args) {
                    if (arg.type === &#39;Identifier&#39;) {
                        calledDecls.push(visitor.visitNode(arg))
                    }
                }
            }
        }
    }
    if (node.type === &#39;Identifier&#39;) {
        calledDecls.push(node.name);
    }
    code.push(visitor.run([node]));
});

code = calledDecls.map(c =&gt; {
    return decls.get(c);
}).join(&#39;&#39;);

fs.writeFileSync(__dirname + &#39;/test.shaked.js&#39;, code)

</code></pre></div><div class="language-javascript ext-js"><pre class="language-javascript"><code>// visitor.js  处理ast的代码
class Visitor {

    // 访问变量申明
    visitVariableDeclaration(node) {
        let str = &#39;&#39;;
        str += node.kind + &#39; &#39;;
        str += this.visitNodes(node.declarations);
        return str + &#39;\n&#39;;
    }
    
    // 访问定义的变量名
    visitVariableDeclarator(node, kind) {
        let str = &#39;&#39;;
        str += kind ? kind + &#39; &#39; : str;
        str += this.visitNode(node.id) + &#39; &#39;;
        str += &#39;= &#39;;
        str += this.visitNode(node.init);
        return str + &#39;;&#39; + &#39;\n&#39;;
    }
    // 访问标识符
    visitIdentifier(node) {
        let str = &#39;&#39;;
        str += node.name;
        return str;
    }

    // 访问箭头函数
    visitArrowFunctionExpression(node) {
        let str = &#39;&#39;;
        str += &#39;(&#39;;
        node.params.forEach((param, index) =&gt; {
            str += this.visitNode(param);
            str += (index === node.params.length - 1) ? &#39;&#39; : &#39;,&#39;
        })
        str += &#39;)&#39;;
        str += &#39;=&gt;&#39;;
        str += this.visitNode(node.body);
        return str + &#39;\n&#39;;
    }
    // 访问字符常量
    visitLiteral(node) {
        let str = &#39;&#39;;
        str += node.raw;
        return str;
    }
    // 访问操作符
    visitBinaryExpression(node) {
        let str = &#39;&#39;;
        str += this.visitNode(node.left);
        str += node.operator;
        str += this.visitNode(node.right);
        return str + &#39;\n&#39;;
    }

    visitCallExpression(node) {
        let str = &#39;&#39;;
        str += this.visitNode(node.callee);
        str += &#39;(&#39;;
        node.arguments.forEach((param, index) =&gt; {
            str += this.visitNode(param);
            str += (index === node.arguments.length - 1) ? &#39;&#39;:&#39;,&#39;;
        })
        str += &#39;)&#39;;
        return str;
    }

    visitNodes(nodes) {
        let str = &#39;&#39;
        nodes.forEach(node =&gt; {
            str += this.visitNode(node);
        });
        return str;
    }

    visitNode(node) {
        let str = &#39;&#39;;
        switch (node.type) {
            case &#39;VariableDeclaration&#39;:
                str += this.visitVariableDeclaration(node);
                break;
            case &#39;VariableDeclarator&#39;:
                str += this.visitVariableDeclarator(node);
                break;
            case &#39;Identifier&#39;:
                str += this.visitIdentifier(node);
                break;
            case &#39;ArrowFunctionExpression&#39;:
                str += this.visitArrowFunctionExpression(node);
                break;
            case &#39;BinaryExpression&#39;:
                str += this.visitBinaryExpression(node);
                break;
            case &#39;Literal&#39;:
                str += this.visitLiteral(node);
                break;
            case &#39;CallExpression&#39;:
                str += this.visitCallExpression(node);
                break;
            default:
                break;
        }
        return str;
    }

    run(body) {
        let str = &#39;&#39;;
        // 遍历
        str += this.visitNodes(body);
        return str;
    }
}

module.exports = Visitor;
</code></pre></div><p>在命令行中执行</p><div class="language-bash ext-sh"><pre class="language-bash"><code>node src/index.js src/test.js
</code></pre></div><p>得到test.shaked.js 文件</p><div class="language-javascript ext-js"><pre class="language-javascript"><code>const add = (a,b)=&gt;a+b

;
const num1 = 9;
const num2 = 100;

</code></pre></div><p>至此，一个简单的tree shaking就做完了。</p><!--]--></div></div><!--]--></div>
    <script src="/assets/js/runtime~app.f8bce1fc.js" defer></script><script src="/assets/js/621.f75be8b1.js" defer></script><script src="/assets/js/app.cd85d261.js" defer></script>
  </body>
</html>
